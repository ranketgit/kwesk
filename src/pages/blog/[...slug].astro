---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

// 1. Generate static paths
export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await post.render();

// 2. SEO Logic: Use meta_ fields if they exist, otherwise fallback to standard fields
const seoTitle = post.data.meta_title || post.data.title;
const seoDescription = post.data.meta_description || post.data.description;
const permalink = new URL(Astro.url.pathname, Astro.site).toString();

// 3. Create Schema Markup (JSON-LD)
const schema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": seoTitle,
  "description": seoDescription,
  "image": new URL(post.data.image, Astro.site).toString(),
  "datePublished": post.data.date.toISOString(),
  "author": {
    "@type": "Organization",
    "name": "KWESK",
    "url": Astro.site
  },
  "publisher": {
    "@type": "Organization",
    "name": "KWESK",
    "logo": {
      "@type": "ImageObject",
      "url": new URL("/kwesk-logo.png", Astro.site).toString()
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": permalink
  }
};
---

<Layout 
  title={seoTitle} 
  description={seoDescription} 
  image={post.data.image}
  schema={schema}
>
  <article class="post-page">
    <header class="post-header">
      <img src={post.data.image} alt={post.data.title} class="post-header__bg" />
      <div class="post-header__overlay"></div>
      <div class="container">
        <div class="post-header__content">
          <time datetime={post.data.date.toISOString()}>
            {post.data.date.toLocaleDateString('fr-FR', { dateStyle: 'long' })}
          </time>
          <h1>{post.data.title}</h1>
        </div>
      </div>
    </header>

    <div class="container post-container">
      <div class="prose">
        <Content />
      </div>
      
      <div class="post-footer">
        <a href="/blog" class="back-link">‚Üê Retour aux articles</a>
      </div>
    </div>
  </article>
</Layout>

<style>
  /* Same styles as before */
  .post-header {
    position: relative;
    height: 50vh;
    min-height: 400px;
    display: flex;
    align-items: center;
    color: white;
  }
  .post-header__bg { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; }
  .post-header__overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.5); z-index: 0; }
  .post-header__content { position: relative; z-index: 1; max-width: 800px; margin: 0 auto; text-align: center; }
  .post-header h1 { font-size: 2.5rem; line-height: 1.2; font-weight: 700; }
  .container { max-width: 800px; margin: 0 auto; padding: 0 2rem; }
  .post-container { padding: 4rem 2rem; background: white; }
  .prose :global(h2) { font-size: 1.8rem; color: #1c1917; margin: 2.5rem 0 1rem; font-weight: 700; }
  .prose :global(p) { color: #44403c; line-height: 1.8; margin-bottom: 1.5rem; font-size: 1.1rem; }
  .post-footer { margin-top: 4rem; padding-top: 2rem; border-top: 1px solid #e7e5e4; }
  .back-link { color: #8b8b4b; text-decoration: none; font-weight: 500; }
</style>